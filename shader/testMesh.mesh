#version 460

#extension GL_EXT_mesh_shader : require

layout (local_size_x=128) in;

layout (lines) out;
layout (max_vertices=4, max_primitives=6) out;

layout (binding=0) uniform Camera {
    mat4 mvp;
} camera;
layout (binding=1) buffer Index {
    uvec4 data[];
} index;
layout (binding=2) buffer Vertex {
    vec4 vertexData[];
} vertex;

layout(push_constant) uniform PushConsts {
    uint offset;
} push;

void main() {
    const uint i = gl_LocalInvocationIndex.x;
    const uvec4 tetrahedron = index.data[i + push.offset];
    gl_PrimitiveLineIndicesEXT[0] = uvec2(0, 1);
    gl_PrimitiveLineIndicesEXT[1] = uvec2(0, 2);
    gl_PrimitiveLineIndicesEXT[2] = uvec2(0, 3);
    gl_PrimitiveLineIndicesEXT[3] = uvec2(1, 2);
    gl_PrimitiveLineIndicesEXT[4] = uvec2(1, 3);
    gl_PrimitiveLineIndicesEXT[5] = uvec2(2, 3);

    for(uint x = 0; x < 4; x++) {
        gl_MeshVerticesEXT[x].gl_Position = vertex.vertexData[tetrahedron[x]] * camera.mvp;
    }
    SetMeshOutputsEXT(4, 6);
}
